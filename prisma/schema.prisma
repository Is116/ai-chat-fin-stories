// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Admin users model
model Admin {
  id         Int      @id @default(autoincrement())
  username   String   @unique
  password   String
  email      String   @unique
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("admins")
}

// Regular users model
model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  email         String?        @unique
  password      String?
  fullName      String?        @map("full_name")
  avatar        String?
  googleId      String?        @unique @map("google_id")
  facebookId    String?        @unique @map("facebook_id")
  githubId      String?        @unique @map("github_id")
  provider      String?        @default("local")
  profilePhoto  String?        @map("profile_photo")
  createdAt     DateTime       @default(now()) @map("created_at")
  lastLogin     DateTime?      @map("last_login")
  conversations Conversation[]

  @@index([googleId])
  @@index([facebookId])
  @@index([githubId])
  @@index([email])
  @@map("users")
}

// Books model
model Book {
  id                Int          @id @default(autoincrement())
  title             String
  author            String
  description       String?
  coverImage        String?      @map("cover_image")
  publishedYear     Int?         @map("published_year")
  genre             String?
  language          String?
  pdfFile           String?      @map("pdf_file")
  processingStatus  String?      @map("processing_status")
  errorMessage      String?      @map("error_message")
  totalChunks       Int?         @map("total_chunks")
  processedAt       DateTime?    @map("processed_at")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @default(now()) @updatedAt @map("updated_at")
  characters        Character[]
  bookChunks        BookChunk[]

  @@map("books")
}

// Characters model
model Character {
  id                   Int                   @id @default(autoincrement())
  name                 String
  bookId               Int                   @map("book_id")
  personality          String
  avatar               String?
  image                String?
  color                String
  greeting             String
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @default(now()) @updatedAt @map("updated_at")
  book                 Book                  @relation(fields: [bookId], references: [id], onDelete: Cascade)
  conversations        Conversation[]
  extractedCharacters  ExtractedCharacter[]
  characterPersonas    CharacterPersona[]

  @@index([bookId])
  @@map("characters")
}

// Conversations model
model Conversation {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  characterId Int       @map("character_id")
  title       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  messages    Message[]

  @@index([userId])
  @@index([characterId])
  @@map("conversations")
}

// Messages model
model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int          @map("conversation_id")
  role           String
  content        String
  image          String?
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// Prompts model
model Prompt {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  type        String
  content     String
  description String?
  isActive    Int      @default(1) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("prompts")
}

// Book chunks for RAG (AI processing)
model BookChunk {
  id            Int      @id @default(autoincrement())
  bookId        Int      @map("book_id")
  chunkId       String?  @map("chunk_id")
  chunkText     String   @map("chunk_text")
  chapterNumber Int?     @map("chapter_number")
  wordCount     Int?     @map("word_count")
  chunkIndex    Int?     @map("chunk_index")
  createdAt     DateTime @default(now()) @map("created_at")
  book          Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@map("book_chunks")
}

// Extracted characters from AI processing
model ExtractedCharacter {
  id          Int       @id @default(autoincrement())
  bookId      Int       @map("book_id")
  characterId Int?      @map("character_id")
  name        String
  description String
  rawData     String?   @map("raw_data")
  createdAt   DateTime  @default(now()) @map("created_at")
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)

  @@index([bookId])
  @@index([characterId])
  @@map("extracted_characters")
}

// Character personas for RAG
model CharacterPersona {
  id          Int       @id @default(autoincrement())
  characterId Int       @map("character_id")
  persona     String
  context     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@map("character_personas")
}
